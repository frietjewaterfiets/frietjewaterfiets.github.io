<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flightradar Simulator</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --g1:#4d4d4d;
    --g2:#303030;
    --y:#e3b021;
    --text:#f3f3f3;
    --muted:#d0d0d0;
    --dock-w:360px;
  }

  html,body,#map{height:100%;margin:0}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#1b1b1b;color:var(--text)}
  .app{display:flex;height:100vh;overflow:hidden;position:relative}

  /* Dock */
  .dock{
    width:var(--dock-w); min-width:320px; max-width:420px;
    padding:12px; gap:12px; box-sizing:border-box;
    display:flex; flex-direction:column;
    transition:width .25s ease, padding .25s ease;
    z-index:920;
  }
  .dock.collapsed{ width:0; min-width:0; padding:0; overflow:hidden; }

  /* Lip */
  .dock-tab{
    position:absolute; top:50%; transform:translateY(-50%);
    left:calc(var(--dock-w) - 12px);
    z-index:930;
    width:24px; height:52px;
    background:var(--g2);
    border:1px solid #222; border-left:none;
    border-radius:0 10px 10px 0;
    color:var(--y);
    box-shadow:0 6px 16px rgba(0,0,0,.35);
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    font-weight:900; pointer-events:auto;
  }
  .dock.collapsed + .dock-tab{ left:0; border-left:1px solid #222; border-radius:10px; }
  .dock-tab .chev{ font-size:16px; line-height:1; }

  /* Card */
  .card{
    background:linear-gradient(180deg,var(--g1) 0%,var(--g2) 100%);
    border:1px solid #262626; border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    color:var(--text); overflow:hidden;
  }
  .card .card-h{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px; background:var(--g2); border-bottom:1px solid #262626;
  }
  .card .dot{width:7px;height:7px;background:var(--y);border-radius:50%}
  .card .title{font-weight:800}
  .card .live{margin-left:auto;font-size:12px;color:#252525;background:var(--y);padding:2px 6px;border-radius:4px;font-weight:800}
  .card .collapse{margin-left:8px;background:transparent;border:0;color:#cfcfcf;font-size:16px;cursor:pointer}
  .card .collapse:hover{color:#fff}

  /* Modes */
  .modes{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px}
  .mode-btn{
    background:#3b3b3b;border:1px solid #2a2a2a;color:var(--text);
    padding:6px 10px;border-radius:7px;font-size:12px;cursor:pointer
  }
  .mode-btn.active{background:#4a4a4a;outline:2px solid #5b5b5b}

  /* Icon grid */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px 12px;max-height:38vh;overflow:auto}
  .item{background:#3a3a3a;border:1px solid #2a2a2a;border-radius:10px;text-align:center;padding:8px;user-select:none}
  .thumb{width:44px;height:44px;margin:2px auto 6px;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:44px;max-height:44px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.45))}
  .lbl{font-size:12px;color:var(--muted)}
  .item.selected{outline:2px solid color-mix(in srgb, var(--y) 60%, transparent); box-shadow:0 0 0 2px color-mix(in srgb, var(--y) 25%, transparent) inset}

  /* Controls */
  .controls{padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
  .controls .row-2{grid-column:1 / span 2}
  .btn{
    background:#3a3a3a;border:1px solid #2a2a2a;color:var(--text);
    padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800
  }
  .btn:hover{background:#454545}
  .btn.primary{background:linear-gradient(180deg,#4a4a4a,#3a3a3a)}
  .btn.yellow{ color:#161616; box-shadow: inset 0 0 0 999px var(--y); border:1px solid #6a5713; background:#5e4d11; }

  /* Slider */
  .slider-wrap{display:flex;flex-direction:column;gap:6px}
  .slider-head{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
  input[type="range"]{width:100%}

  /* Map */
  #map{flex:1;position:relative;z-index:800}
  .leaflet-pane.leaflet-tile-pane{ filter:brightness(0.62) saturate(0.9) contrast(0.95); }
  .leaflet-pane.leaflet-tile-pane::after{ content:"";position:absolute;inset:0;background:rgba(10,10,10,.35);pointer-events:none; }
  .map-topfade{position:absolute;left:0;right:0;top:0;height:120px;pointer-events:none;z-index:850;
    background:linear-gradient(180deg, rgba(0,0,0,.46) 0%, rgba(0,0,0,.22) 45%, rgba(0,0,0,0) 100%);
  }
  .map-logo{position:absolute;left:50%;top:12px;transform:translateX(-50%);z-index:900;pointer-events:none}
  .map-logo img{height:50px;display:block;filter:drop-shadow(0 2px 6px rgba(0,0,0,.45))}

  /* Info rechts */
  .info{position:absolute;right:12px;top:12px;width:300px;background:rgba(20,20,20,.92);color:#f0f6ff;border-radius:12px;padding:10px;box-shadow:0 8px 20px rgba(2,6,12,.65);display:none;z-index:880}
  .row{display:flex;justify-content:space-between;font-size:13px;margin:4px 0}
  .row b{color:#fff}

  .icon-div .rot{display:inline-block;transform-origin:50% 50%}
  .icon-div img{width:34px;height:34px;display:block}
  .balloon img{animation:bob 2.6s ease-in-out infinite}
  .sat img{animation:twinkle 1.6s ease-in-out infinite}
  @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
  @keyframes twinkle{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}

  .leaflet-marker-icon, .leaflet-marker-icon * { outline: none !important; }

  *{scrollbar-width:thin;scrollbar-color:#666 transparent}
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-thumb{background:#666;border-radius:6px}
  ::-webkit-scrollbar-track{background:transparent}
</style>
</head>
<body>
<div class="app">
  <!-- Linkerpaneel -->
  <aside class="dock" id="dock">
    <section class="card">
      <div class="card-h">
        <div class="dot"></div>
        <div class="title">Most tracked flights</div>
        <span class="live">LIVE</span>
        <button id="collapseDock" class="collapse" title="Paneel inklappen">▸</button>
      </div>

      <div class="modes" id="styleBar"></div>
      <div class="grid" id="iconGrid"></div>

      <div class="controls">
        <button id="addRandom" class="btn primary">Spawn at center</button>
        <button id="clearAll" class="btn">Clear map</button>

        <!-- 2 knoppen -->
        <button id="randomFillerBtn" class="btn yellow row-2">Random filler</button>
        <button id="selectedFillerBtn" class="btn yellow row-2">Selected filler</button>

        <!-- Eén radius schuifje voor beide -->
        <div class="slider-wrap row-2">
          <div class="slider-head">
            <span>Radius</span>
            <span id="radiusLabel">2000 m</span>
          </div>
          <!-- 50 m – 2500 km -->
          <input id="radiusSlider" type="range" min="50" max="2500000" step="50" value="2000" />
        </div>

        <!-- Show Center point -->
        <div class="row-2" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="showCenterPoint"/>
          <label for="showCenterPoint" style="user-select:none;cursor:pointer">Show Center point</label>
        </div>
      </div>
    </section>
  </aside>

  <!-- Lip -->
  <button id="dockTab" class="dock-tab" title="Menu open/dicht">
    <span class="chev">◀</span>
  </button>

  <!-- Kaart -->
  <div id="map">
    <div class="map-topfade"></div>
    <div class="map-logo"><img src="img/logo.png" alt="Logo"></div>
  </div>
</div>

<!-- Info rechts -->
<div class="info" id="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
    <div>
      <b id="pTitle">—</b>
      <div style="font-size:12px;opacity:.85" id="pSub">—</div>
      <div style="font-size:11px;opacity:.8" id="pMode">—</div>
    </div>
    <button id="closeInfo" style="padding:6px 10px;font-size:12px;background:#3a3a3a;border:1px solid #2a2a2a;border-radius:8px;color:#eee;cursor:pointer">Close</button>
  </div>
  <div class="row"><span>From</span><b id="pFrom">—</b></div>
  <div class="row"><span>To</span><b id="pTo">—</b></div>
  <div class="row"><span>Alt</span><b id="pAlt">—</b></div>
  <div class="row"><span>Speed</span><b id="pSpd">—</b></div>
  <div class="row"><span>Track</span><b id="pTrk">—</b></div>
  <div class="row"><span>ETA</span><b id="pEta">—</b></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Dock inklappen met vaste lip */
(function(){
  const dock = document.getElementById('dock');
  const collapseBtn = document.getElementById('collapseDock');
  const dockTab = document.getElementById('dockTab');
  let map;
  window.__setMap = (m)=>{ map = m; };

  function setChevron(){
    dockTab.querySelector('.chev').textContent = dock.classList.contains('collapsed') ? '▶' : '◀';
  }
  function invalidate(){ setTimeout(()=>{ map && map.invalidateSize(); }, 260); }
  function collapse(){ dock.classList.add('collapsed'); setChevron(); invalidate(); }
  function expand(){ dock.classList.remove('collapsed'); setChevron(); invalidate(); }
  function toggle(){ dock.classList.contains('collapsed') ? expand() : collapse(); }

  collapseBtn.addEventListener('click', collapse);
  dockTab.addEventListener('click', toggle);
  setChevron();
})();
</script>

<script>
/* ===== App logica ===== */
(function(){
  const STYLES={
    manual:{name:'Manual',kind:'manual'},
    normal:{name:'Normal',base:0.55,kind:'straight'},
    static:{name:'Static',kind:'static'},
    drunk:{name:'Drunk',base:0.60,kind:'drunk'}
  };
  let currentStyleKey='normal';
  const styleBar=document.getElementById('styleBar');
  Object.entries(STYLES).forEach(([k,c])=>{
    const b=document.createElement('button');
    b.className='mode-btn'+(k===currentStyleKey?' active':'');
    b.textContent=c.name;
    b.onclick=()=>{ currentStyleKey=k; [...styleBar.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
    styleBar.appendChild(b);
  });

  const makePlane=(file,name)=>({file,name,kind:'plane'});
  const ICONS=[
    {file:'img/balloon.png',name:'Balloon',kind:'balloon'},
    {file:'img/cart.png',name:'Cart',kind:'cart'},
    {file:'img/fatbike.png',name:'Fatbike',kind:'fatbike'},
    {file:'img/santa.png',name:'Santa',kind:'plane'},
    {file:'img/satellite.png',name:'Satellite',kind:'satellite'},
    {file:'img/heli1.gif',name:'Heli1',kind:'heli'},
    makePlane('img/v1.png','v1'),makePlane('img/v2.png','v2'),makePlane('img/v3.png','v3'),
    makePlane('img/v4.png','v4'),makePlane('img/v5.png','v5'),makePlane('img/v6.png','v6'),
    makePlane('img/v7.png','v7'),makePlane('img/v8.png','v8'),makePlane('img/v9.png','v9'),
    makePlane('img/v10.png','v10'),makePlane('img/v11.png','v11'),makePlane('img/v12.png','v12'),
    makePlane('img/v13.png','v13'),makePlane('img/v14.png','v14')
  ];
  let chosenIcon=null;
  const grid=document.getElementById('iconGrid');
  ICONS.forEach(it=>{
    const el=document.createElement('div');
    el.className='item'; el.draggable=true;
    el.innerHTML=`<div class="thumb"><img src="${it.file}" alt=""></div><div class="lbl">${it.name}</div>`;
    el.addEventListener('dragstart',ev=>{
      ev.dataTransfer.effectAllowed='copy';
      ev.dataTransfer.setData('text/plain', JSON.stringify({icon:it.file,title:it.name,kind:it.kind}));
      chosenIcon=it; [...grid.children].forEach(x=>x.classList.remove('selected')); el.classList.add('selected');
    });
    el.addEventListener('click', ()=>{ chosenIcon=it; [...grid.children].forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); });
    grid.appendChild(el);
  });

  /* Map */
  const map=L.map('map',{center:[52.31,4.77],zoom:8,worldCopyJump:true,keyboard:false});
  window.__setMap(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

  /* Drag & drop uit het menu naar de kaart */
  const mapEl=map.getContainer();
  mapEl.addEventListener('dragover',e=>{e.preventDefault(); e.dataTransfer.dropEffect='copy';});
  mapEl.addEventListener('drop',e=>{
    e.preventDefault();
    const t=e.dataTransfer.getData('text/plain'); if(!t) return;
    const d=JSON.parse(t);
    const r=mapEl.getBoundingClientRect();
    const ll=map.containerPointToLatLng(L.point(e.clientX-r.left,e.clientY-r.top));
    spawnWithCurrentMode({icon:d.icon,title:d.title,kind:d.kind}, ll);
  });

  /* Buttons */
  function spawnAtCenter(){
    const it=chosenIcon||ICONS[0];
    spawnWithCurrentMode({icon:it.file,title:it.name,kind:it.kind}, map.getCenter());
  }
  document.getElementById('addRandom').onclick=spawnAtCenter;
  document.getElementById('clearAll').onclick=()=>Object.keys(active).forEach(id=>removeObj(id));
  document.getElementById('randomFillerBtn').onclick=()=>fillWithTrafficRandomRadius();
  document.getElementById('selectedFillerBtn').onclick=()=>fillWithTrafficSelectedRadius();

  /* Radius slider (gedeeld) + label */
  const radiusSlider = document.getElementById('radiusSlider');
  const radiusLabel  = document.getElementById('radiusLabel');
  const fmtRadius = (m)=> m>=1000 ? (Math.round(m/100)/10)+' km' : (Math.round(m)+' m');
  function getRadiusMeters(){
    const v = parseInt(radiusSlider.value,10);
    const clamped = isNaN(v) ? 2000 : Math.max(50, Math.min(2500000, v));
    return clamped;
  }
  function setRadiusMeters(v){
    const clamped = Math.max(50, Math.min(2500000, v|0));
    radiusSlider.value = clamped;
    updateRadiusLabel();
    updateCenterOverlay();
  }
  function updateRadiusLabel(){ radiusLabel.textContent = fmtRadius(getRadiusMeters()); }
  radiusSlider.addEventListener('input', ()=>{ updateRadiusLabel(); updateCenterOverlay(); });
  updateRadiusLabel();

  /* Center overlay (cirkel + punt) */
  const showCenterChk = document.getElementById('showCenterPoint');
  let centerCircle=null, centerDot=null;

  function ensureCenterLayers(){
    if(!centerCircle){
      centerCircle = L.circle(map.getCenter(), {
        radius: getRadiusMeters(),
        color: '#e3b021',
        weight: 2,
        fill: false,
        opacity: 0.9
      });
    }
    if(!centerDot){
      centerDot = L.circleMarker(map.getCenter(), {
        radius: 3,
        color: '#e3b021',
        weight: 2,
        fill: true,
        fillOpacity: 1
      });
    }
  }
  function showCenterOverlay(on){
    if(on){
      ensureCenterLayers();
      centerCircle.addTo(map);
      centerDot.addTo(map);
      updateCenterOverlay();
    }else{
      if(centerCircle) map.removeLayer(centerCircle);
      if(centerDot)    map.removeLayer(centerDot);
    }
  }
  function updateCenterOverlay(){
    if(!centerCircle || !map.hasLayer(centerCircle)) return;
    const c = map.getCenter();
    centerCircle.setLatLng(c);
    centerCircle.setRadius(getRadiusMeters());
    if(centerDot && map.hasLayer(centerDot)) centerDot.setLatLng(c);
  }

  showCenterChk.addEventListener('change', ()=> showCenterOverlay(showCenterChk.checked));
  map.on('move', updateCenterOverlay); // volg het kaart-centrum live

  /* ====== NIEUW: Keyboard acties ====== */
  // 1) Spatie = Spawn at center (als je in een invoerveld zit, negeren)
  window.addEventListener('keydown', (e)=>{
    const tag=(e.target||{}).tagName||'';
    const typing = /INPUT|TEXTAREA|SELECT/.test(tag);
    if(!typing && (e.code==='Space' || e.key===' ')){
      e.preventDefault();
      spawnAtCenter();
    }
  });

  // 2) F ingedrukt + muis slepen = radius aanpassen (Photoshop-achtig)
  let fDragActive=false;
  const PX_TO_METERS = 250; // 1px = 250 m (tune gerust)
  window.addEventListener('keydown', (e)=>{
    if((e.key==='f' || e.key==='F') && !fDragActive){
      fDragActive=true;
      document.body.style.cursor='ew-resize';
    }
  });
  window.addEventListener('keyup', (e)=>{
    if((e.key==='f' || e.key==='F') && fDragActive){
      fDragActive=false;
      document.body.style.cursor='';
    }
  });
  window.addEventListener('mousemove', (e)=>{
    if(!fDragActive) return;
    const delta = e.movementX || 0;     // alleen horizontale beweging
    if(delta===0) return;
    const newVal = getRadiusMeters() + delta * PX_TO_METERS;
    setRadiusMeters(newVal);
  });

  /* State & helpers */
  const active={}, R=6371000; let seq=1; let selectedId=null;
  function divIcon(url, angle, opt={}){ const rotate=!opt.noRotate, extra=(opt.extraClass||''); const rot=rotate?`transform:rotate(${angle}deg)`:''; const html=`<div class="icon-div ${extra}"><span class="rot" style="${rot}"><img src="${url}" alt=""></span></div>`; return L.divIcon({html,className:'',iconSize:[34,34],iconAnchor:[17,17]});}
  function destPoint(lat,lon,brgDeg,distM){const br=brgDeg*Math.PI/180, φ1=lat*Math.PI/180, λ1=lon*Math.PI/180, δ=distM/R; const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(br)); const λ2=λ1+Math.atan2(Math.sin(br)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2)); return [φ2*180/Math.PI, ((λ2*180/Math.PI+540)%360)-180];}
  const lerp=(a,b,t)=>[a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t];
  function bearing(a,b){const A=a[0]*Math.PI/180,B=b[0]*Math.PI/180,d=(b[1]-a[1])*Math.PI/180; const y=Math.sin(d)*Math.cos(B), x=Math.cos(A)*Math.sin(B)-Math.sin(A)*Math.cos(B)*Math.cos(d); let h=Math.atan2(y,x)*180/Math.PI; if(h<0) h+=360; return Math.round(h);}

  async function buildRoadLoop(obj, kind){
    try{
      const start=obj.marker.getLatLng();
      const center={lat:start.lat,lng:start.lng};
      const rM=kind==='fatbike'?250:700;
      function rp(){const br=Math.random()*360; return destPoint(center.lat,center.lng,br,rM);}
      const p1=rp(),p2=rp();
      const profile=(kind==='fatbike')?'cycling':'driving';
      const coords=[[center.lng,center.lat],[p1[1],p1[0]],[p2[1],p2[0]],[center.lng,center.lat]].map(p=>p.join(',')).join(';');
      const url=`https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson&roundtrip=false&steps=false`;
      const res=await fetch(url); if(!res.ok) throw new Error('routing');
      const data=await res.json(); const line=data?.routes?.[0]?.geometry?.coordinates; if(!line?.length) throw new Error('nogeo');
      const route=line.map(([lo,la])=>[la,lo]); route[0]=[center.lat,center.lng];
      obj.route=route; obj.step=0; obj.t=0; obj.autoModel='route';
      obj._roadBase=(kind==='fatbike')?0.035:0.10;
    }catch(e){
      const p=obj.marker.getLatLng();
      if(kind==='fatbike'){ obj.route=makeFatbikeLoop(p); obj._roadBase=0.035; }
      else { obj.route=makeCartLoop(p); obj._roadBase=0.10; }
      obj.step=0; obj.t=0; obj.autoModel='route';
    }
  }
  function makeLoopRoute(c,rKm=20,pts=64,wob=0.35){const rt=[[c.lat,c.lng]];let base=Math.random()*360;for(let i=1;i<pts;i++){const t=i/pts;const ang=base+t*360+(Math.random()-.5)*wob*60;const rad=rKm*(.8+Math.random()*.4);rt.push(destPoint(c.lat,c.lng,ang,rad*1000));}rt[rt.length-1]=lerp(rt[rt.length-1],rt[0],.7);return rt;}
  function makeCartLoop(c){return makeLoopRoute(c,.3+Math.random()*.8,40,.25);}
  function makeFatbikeLoop(c){return makeLoopRoute(c,.10+Math.random()*.30,36,.20);}

  function applyStyleTo(o,key,reset=false){
    if(o.styleLocked && key!==o.styleKey && !reset) return;
    o.mode='auto'; o.manual=null; o.styleKey=key; const s=STYLES[key];

    if(key==='static'){
      const c=o.marker.getLatLng(); o.route=[[c.lat,c.lng]]; o.step=0; o.t=0; o.data.spd=0; o.autoModel='static';
    }
    else if(key==='drunk'){
      const v7=o.isV7?1.4:1.0; o.speedScale=(o.speedScale||s.base||1)*v7;
      const c=o.marker.getLatLng();
      o.spinCenter={lat:c.lat,lng:c.lng};
      o.spinRadiusKm=(o.isV7?2.5:1)+Math.random()*4;
      o.spinAngle=Math.random()*360;
      o.spinSpeedDps=(o.isV7?160:60)+Math.random()*180;
      o._drunkT=0; o.route=[[c.lat,c.lng]]; o.autoModel='drunk';
    }
    else if(key==='normal'){
      o.speedScale=(o.speedScale||1); o.spinCenter=null;

      if(o.kind==='plane'){
        o.autoModel='straight';
        if(reset || o.straightHeading==null){
          o.straightHeading=Math.random()*360;
          if(o.isV7){ o.straightSpeedMS=230+Math.random()*70; if(o.speedScale<1.15) o.speedScale=1.15; }
          else { o.straightSpeedMS=80+Math.random()*120; }
        }
      } else if(o.kind==='heli'){
        const c=o.marker.getLatLng();
        o.autoModel='heli';
        o.heliCenter={lat:c.lat,lng:c.lng};
        o.heliAngle=Math.random()*360;
        o.heliRadiusKm=0.3+Math.random()*0.5;
        o.heliTurnDps=25+Math.random()*25;
        o.heliJitter=0;
      } else {
        o.autoModel='route';
        const p=o.marker.getLatLng();
        if(o.kind==='cart') buildRoadLoop(o,'cart');
        else if(o.kind==='fatbike') buildRoadLoop(o,'fatbike');
        else if(o.kind==='satellite') o.route=makeLoopRoute(p,120,96,.1);
        else if(o.kind==='balloon')   o.route=makeLoopRoute(p,12,56,.6);
        o.step=0; o.t=0;
      }
    }
    updateIcon(o); refreshPanel();
  }

  function toManual(o){ o.mode='manual'; o.manual={heading:(o.heading||0), speedMS:20}; updateIcon(o); refreshPanel(); }

  function spawnWithCurrentMode(d,ll){
    const id=addObject(d,ll); selectObj(id); const o=active[id]; o.styleLocked=true; o.spawnStyle=currentStyleKey;
    if(currentStyleKey==='manual' && o.kind==='plane'){ o.spawnedWithManual=true; o.prevAutoStyle='normal'; toManual(o); }
    else { o.spawnedWithManual=false; o.prevAutoStyle=(currentStyleKey==='manual'?'normal':currentStyleKey); applyStyleTo(o, o.prevAutoStyle||'normal', true); }
  }

  function addObject(data,ll){
    const id='o'+(seq++), prov=(currentStyleKey==='manual')?'normal':currentStyleKey, s=STYLES[prov]||STYLES.normal;
    let route;
    if((STYLES[prov]||{}).kind==='static'){route=[[ll.lat,ll.lng]];}
    else if(data.kind==='cart'||data.kind==='fatbike'||data.kind==='heli'){route=[[ll.lat,ll.lng]];}
    else if(data.kind==='satellite'){route=makeLoopRoute(ll,120,96,.1);}
    else if(data.kind==='balloon'){route=makeLoopRoute(ll,12,56,.6);}
    else{route=[[ll.lat,ll.lng],destPoint(ll.lat,ll.lng,Math.random()*360,500)];}

    const noRot=(data.kind==='balloon'||data.kind==='satellite'||data.kind==='fatbike');
    const extra=data.kind==='balloon'?'balloon':(data.kind==='satellite'?'sat':'');

    // >>> Belangrijk: markers NIET interactief maken zodat navigeren altijd kan
    const marker=L.marker(ll,{
      icon:divIcon(data.icon,0,{noRotate:noRot,extraClass:extra}),
      draggable:false,
      interactive:false,   // blokkeert clicks/hover/drag op de marker
      keyboard:false,
      title:data.title
    }).addTo(map);

    active[id]={id,kind:data.kind||'plane',marker,route,step:0,t:0,styleKey:prov,speedScale:s.base||1,data:{icon:data.icon,title:data.title},
      paused:false,manual:null,spawnedWithManual:false,prevAutoStyle:'normal',spinCenter:null,spinRadiusKm:0,spinAngle:0,spinSpeedDps:0,_drunkT:0,
      heading:0,autoModel:null,straightHeading:0,straightSpeedMS:120,styleLocked:false,spawnStyle:null,isV7:(data.title?.toLowerCase()==='v7')||/v7\.png$/i.test(data.icon),_roadBase:undefined};

    active[id].timer=setInterval(()=>{ if(!active[id].paused) tick(id,1/20); }, 50);
    return id;
  }

  function updateIcon(o){
    const noRot=(o.kind==='balloon'||o.kind==='satellite'||o.kind==='fatbike');
    const extra=o.kind==='balloon'?'balloon':(o.kind==='satellite'?'sat':'');
    o.marker.setIcon(divIcon(o.data.icon,o.heading||0,{noRotate:noRot,extraClass:extra}));
  }

  function tick(id,dt){
    const o=active[id]; if(!o) return;

    // MANUAL (alleen als zo gespawned; markers zijn toch niet interactief)
    if(o.mode==='manual'&&o.manual){
      if(!(o.kind==='plane'&&o.spawnedWithManual)){ applyStyleTo(o,o.prevAutoStyle||'normal',true); return; }
      const m=o.manual,acc=(keys.w||keys.arrowUp?8:0)+(keys.s||keys.arrowDown?-10:0);
      m.speedMS=Math.max(0,Math.min(250,m.speedMS+acc*dt));
      if(keys.a||keys.arrowLeft)m.heading=(m.heading-120*dt+360)%360;
      if(keys.d||keys.arrowRight)m.heading=(m.heading+120*dt)%360;
      const c=o.marker.getLatLng(),nx=destPoint(c.lat,c.lng,m.heading,m.speedMS*dt);
      o.marker.setLatLng(nx); o.heading=m.heading; updateIcon(o);
      o.data.alt=9000; o.data.spd=Math.round(m.speedMS*1.94); o.data.trk=Math.round(o.heading);
      if(selectedId===id) refreshPanel(); return;
    }

    // DRUNK
    if(o.styleKey==='drunk'&&o.spinCenter){
      o._drunkT+=dt;
      if(o._drunkT>3){
        o._drunkT=0; const mult=o.isV7?1.2:1.0;
        o.spinSpeedDps=Math.max(40,Math.min(320,(o.spinSpeedDps+(Math.random()-.5)*60)*mult));
        o.spinRadiusKm=Math.max(.5,Math.min(6,o.spinRadiusKm+(Math.random()-.5)*.8));
        const c=o.spinCenter,shift=(Math.random()-.5)*.8,dir=Math.random()*360;
        const [nl,ng]=destPoint(c.lat,c.lng,dir,Math.abs(shift)*1000); o.spinCenter={lat:nl,lng:ng};
      }
      o.spinAngle=(o.spinAngle+o.spinSpeedDps*dt)%360;
      const pos=destPoint(o.spinCenter.lat,o.spinCenter.lng,o.spinAngle,o.spinRadiusKm*1000);
      const tan=(o.spinAngle+90)%360;
      o.marker.setLatLng(pos); o.heading=tan; updateIcon(o);
      o.data.alt=9000+Math.round(500*Math.sin(o.spinAngle*Math.PI/90)); o.data.spd=Math.round(120+o.spinSpeedDps); o.data.trk=Math.round(tan);
      if(selectedId===id) refreshPanel(); return;
    }

    // STATIC
    if(o.styleKey==='static'){ o.data.spd=0; if(selectedId===id) refreshPanel(); return; }

    // HELI loiter
    if(o.styleKey==='normal' && o.kind==='heli' && o.autoModel==='heli'){
      o.heliJitter += dt;
      if(o.heliJitter > 2){
        o.heliJitter = 0;
        o.heliRadiusKm = Math.max(0.15, Math.min(1.2, o.heliRadiusKm + (Math.random()-0.5)*0.1));
        o.heliTurnDps = Math.max(15, Math.min(60, o.heliTurnDps + (Math.random()-0.5)*6));
      }
      o.heliAngle = (o.heliAngle + o.heliTurnDps * dt) % 360;
      const pos = destPoint(o.heliCenter?.lat||o.marker.getLatLng().lat, o.heliCenter?.lng||o.marker.getLatLng().lng, o.heliAngle, o.heliRadiusKm * 1000);
      const tang = (o.heliAngle + 90) % 360;
      o.marker.setLatLng(pos); o.heading=tang; updateIcon(o);
      o.data.alt = 500 + Math.round(50 * Math.sin(o.heliAngle * Math.PI / 90));
      o.data.spd = 60;
      o.data.trk = Math.round(tang);
      if(selectedId===id) refreshPanel(); return;
    }

    // PLANES straight
    if(o.styleKey==='normal'&&o.kind==='plane'){
      const c=o.marker.getLatLng(),v=o.straightSpeedMS*(o.speedScale||1);
      const nx=destPoint(c.lat,c.lng,o.straightHeading,v*dt);
      o.marker.setLatLng(nx); o.heading=o.straightHeading; updateIcon(o);
      o.data.alt=9000; o.data.spd=Math.round(v*1.94); o.data.trk=Math.round(o.heading);
      if(selectedId===id) refreshPanel(); return;
    }

    // ROUTE-volgers
    const r=o.route; if(!r||r.length<2) return;
    let base;
    if(o.kind==='balloon') base=0.04;
    else if(o.kind==='satellite') base=0.8;
    else if(o.kind==='cart') base=o._roadBase??0.10;
    else if(o.kind==='fatbike') base=o._roadBase??0.035;
    else base=0.5;
    o.t+=dt*base*(o.speedScale||1); while(o.t>=1){ o.step=(o.step+1)%(r.length-1); o.t-=1; }
    const a=r[o.step], b=r[o.step+1], pos2=lerp(a,b,o.t), hdg=bearing(a,b);
    o.marker.setLatLng(pos2); o.heading=hdg; updateIcon(o);

    if(o.kind==='balloon'){ o.data.alt=3000+Math.round(400*Math.sin((o.step+o.t)/r.length*Math.PI*2)); o.data.spd=8+Math.round(4*Math.cos((o.step+o.t)/r.length*Math.PI)); }
    else if(o.kind==='satellite'){ o.data.alt=250000; o.data.spd=17500; }
    else if(o.kind==='cart'){ o.data.alt=0; o.data.spd=15+Math.round(10*Math.cos((o.step+o.t)/r.length*Math.PI)); }
    else if(o.kind==='fatbike'){ o.data.alt=0; o.data.spd=8+Math.round(4*Math.cos((o.step+o.t)/r.length*Math.PI)); }
    o.data.trk=Math.round(o.heading); if(selectedId===id) refreshPanel();
  }

  function removeObj(id){ const o=active[id]; if(!o) return; clearInterval(o.timer); map.removeLayer(o.marker); if(selectedId===id){selectedId=null; hidePanel();} delete active[id]; }

  const panel=document.getElementById('panel');
  const pTitle=document.getElementById('pTitle'), pSub=document.getElementById('pSub'), pMode=document.getElementById('pMode');
  const pFrom=document.getElementById('pFrom'), pTo=document.getElementById('pTo'), pAlt=document.getElementById('pAlt'), pSpd=document.getElementById('pSpd'), pTrk=document.getElementById('pTrk'), pEta=document.getElementById('pEta');
  const APS=['AMS','RTM','EIN','OSL','BGO','LGW','STN','CPH','BRU','CDG','FRA','ZRH','MAD','LIS','VIE','BER'];

  function selectObj(id){
    selectedId=id; const o=active[id]; if(!o) return;
    panel.style.display='block';
    pTitle.textContent=o.data.title||'—';
    pSub.textContent=(o.kind==='balloon')?'Balloon drift':(o.kind==='satellite'?'LEO pass':(o.kind==='cart'?'Airside cart':(o.kind==='fatbike'?'Fatbike (slow)':(o.kind==='heli'?'Helicopter loiter':'Fake flight'))));
    pFrom.textContent=APS[Math.floor(Math.random()*APS.length)];
    let b=pFrom.textContent; do{ pTo.textContent=APS[Math.floor(Math.random()*APS.length)]; } while(pTo.textContent===b);
    refreshPanel(); updateIcon(o);
  }
  function refreshPanel(){
    const o=active[selectedId]; if(!o) return;
    pAlt.textContent=o.kind==='satellite' ? (o.data.alt+' m') : (o.data.alt||0)+' ft';
    const kmhTypes=(o.kind==='cart'||o.kind==='fatbike'||o.kind==='heli');
    pSpd.textContent=(o.data.spd||0) + (o.kind==='satellite'?' m/s': (kmhTypes?' km/h' : ' kt'));
    pTrk.textContent=(o.data.trk||0) + '°';
    const label=(o.mode==='manual' && o.spawnedWithManual && o.kind==='plane') ? 'Mode: MANUAL (WASD/Arrows, Esc → auto)' :
                (o.styleKey==='drunk')?'Mode: AUTO (Drunk — locked)' :
                (o.styleKey==='static')?'Mode: AUTO (Static — locked)' :
                (o.kind==='heli'?'Mode: AUTO (Heli loiter — locked)':'Mode: AUTO (Normal — straight, locked)');
    pMode.textContent=label;
    const remain=o.route?(o.route.length-o.step-o.t):10;
    const mins=Math.max(1, Math.round((o.kind==='satellite'?5:10)+remain*1.1));
    const eta=new Date(Date.now()+mins*60000); pEta.textContent=eta.toTimeString().slice(0,5);
  }
  function hidePanel(){ panel.style.display='none'; }
  document.getElementById('closeInfo').onclick=()=>{ selectedId=null; hidePanel(); };

  const keys={w:false,a:false,s:false,d:false,arrowUp:false,arrowDown:false,arrowLeft:false,arrowRight:false};
  window.addEventListener('keydown',e=>{
    if(!selectedId || !active[selectedId]) return;
    const k=e.key; const o=active[selectedId];
    if(['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)){
      if(!(o.mode==='manual' && o.kind==='plane' && o.spawnedWithManual)) return;
      e.preventDefault();
      if(k==='w') keys.w=true; if(k==='a') keys.a=true; if(k==='s') keys.s=true; if(k==='d') keys.d=true;
      if(k==='ArrowUp') keys.arrowUp=true; if(k==='ArrowDown') keys.arrowDown=true; if(k==='ArrowLeft') keys.arrowLeft=true; if(k==='ArrowRight') keys.arrowRight=true;
    }else if(k===' '){
      // Space handling voor manual brake blijft maar wordt overschaduwd door globale spawn (boven)
      if(!(o.mode==='manual' && o.kind==='plane' && o.spawnedWithManual)) return; e.preventDefault(); o.manual&&(o.manual.speedMS=0);
    }else if(k==='Escape'){ if(o.mode==='manual'){ applyStyleTo(o, o.prevAutoStyle || 'normal', true); } }
  });
  window.addEventListener('keyup',e=>{
    const k=e.key;
    if(k==='w') keys.w=false; if(k==='a') keys.a=false; if(k==='s') keys.s=false; if(k==='d') keys.d=false;
    if(k==='ArrowUp') keys.arrowUp=false; if(k==='ArrowDown') keys.arrowDown=false; if(k==='ArrowLeft') keys.arrowLeft=false; if(k==='ArrowRight') keys.arrowRight=false;
  });

  function randomBetween(a,b){ return a + Math.random()*(b-a); }
  function fillerCountFromZoom(){ const z=map.getZoom(); return Math.max(8, Math.min(50, Math.floor((z-3)*5))); }

  /* Random filler op radius rond center */
  function fillWithTrafficRandomRadius(){
    const count=fillerCountFromZoom();
    const r=getRadiusMeters();
    const c=map.getCenter();

    const normalPlanes=ICONS.filter(x=>x.kind==='plane' && !['cart','fatbike','santa','satellite','balloon'].includes(x.name.toLowerCase()));
    const v7=ICONS.find(x=>x.name==='v7');
    const heli=ICONS.find(x=>x.name==='Heli1');

    for(let i=0;i<count;i++){
      const th=Math.random()*360;
      const d=Math.sqrt(Math.random())*r;         // uniforme dichtheid in cirkel
      const [lat,lng]=destPoint(c.lat,c.lng,th,d);

      let choice=null; const rr=Math.random();
      if(rr<0.02 && v7){ choice=v7; }
      else if(rr<0.03 && heli){ choice=heli; }
      else{
        const pool=normalPlanes.filter(p=>p!==v7);
        choice=pool[Math.floor(Math.random()*pool.length)];
      }

      const id=addObject({icon:choice.file,title:choice.name,kind:choice.kind}, L.latLng(lat,lng));
      const o=active[id];
      o.styleLocked=true; o.spawnStyle='normal'; o.spawnedWithManual=false; o.prevAutoStyle='normal';
      if(o.kind==='plane'){ o.speedScale=randomBetween(0.75,1.50); if(o.isV7){ o.speedScale=Math.max(o.speedScale,1.25); } }
      else if(o.kind==='heli'){ o.speedScale=1; }
      applyStyleTo(o,'normal',true);
    }
  }

  /* Selected filler gebruikt dezelfde radius */
  function fillWithTrafficSelectedRadius(){
    if(!chosenIcon){ alert('Selecteer eerst een object in het menu.'); return; }
    if((chosenIcon.name||'').toLowerCase()==='balloon'){ alert('Balloon is uitgeschakeld voor fillers.'); return; }

    const count=fillerCountFromZoom();
    const r=getRadiusMeters();
    const c=map.getCenter();

    for(let i=0;i<count;i++){
      const th=Math.random()*360;
      const d=Math.sqrt(Math.random())*r;
      const [lat,lng]=destPoint(c.lat,c.lng,th,d);
      const id=addObject({icon:chosenIcon.file,title:chosenIcon.name,kind:chosenIcon.kind}, L.latLng(lat,lng));
      const o=active[id];
      o.styleLocked=true; o.spawnStyle='normal'; o.spawnedWithManual=false; o.prevAutoStyle='normal';
      if(o.kind==='plane'){ o.speedScale=randomBetween(0.75,1.50); if(o.isV7) o.speedScale=Math.max(o.speedScale,1.25); }
      else if(o.kind==='cart'||o.kind==='fatbike'){ o.speedScale=randomBetween(0.9,1.1); }
      applyStyleTo(o,'normal',true);
    }
  }
})();
</script>
</body>
</html>
