<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIGHTPANEL</title>
  <style>
  :root{
    color-scheme: dark;
    --bg:#000;
    --fg:#fff;
    --muted: rgba(255,255,255,.75);
    --line: rgba(255,255,255,.35);
    --accent:#ff00ff;

    /* lightpanel specific */
    --panel-bg:#000;
    --flash:#fff;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    background:var(--bg);
    color:var(--fg);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing:.1px;
  }

  a{
    color:var(--fg);
    text-decoration: underline;
    text-underline-offset: 3px;
  }
  a:hover{
    background: var(--fg);
    color: var(--bg);
  }

  .page{
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  /* 6 vakjes (3x2) vullen het scherm */
  .grid{
    flex: 1 1 auto;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 14px;
    padding: 18px;
  }

  .sq{
    background: var(--panel-bg);
    border: 2px solid var(--line);
    border-radius: 0;
    padding: 0;
    transition: background-color 0s linear;
    user-select:none;
    -webkit-user-select:none;
  }

  /* Onderblok met uitleg + footer */
  .bottom{
    flex: 0 0 auto;
    padding: 16px 18px 0;
  }

  .bottomInner{
    width:100%;
    max-width: 980px;
    margin: 0 auto;
  }

  .desc{
    border: 2px solid var(--line);
    border-radius: 0;
    padding: 14px;
    background: transparent;
    margin: 0 0 12px 0;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.35;
    text-align:center;
  }

  .controlsRow{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    margin: 0 0 12px 0;
    color: var(--muted);
    font-size: 13px;
    border: 2px solid var(--line);
    border-radius: 0;
    padding: 8px 10px;
  }

  input[type="number"]{
    width: 92px;
    padding: 6px 8px;
    border-radius:0;
    border:2px solid var(--line);
    background:transparent;
    color:var(--fg);
    outline:none;
    font-family: inherit;
    font-size: 12px;
    text-align:center;
  }
  input[type="number"]:focus{
    border-color: var(--fg);
  }

  .footer{
    width:100%;
    max-width: 980px;
    margin: 24px auto 0;
    padding: 12px 0 12px;
    border-top: 2px solid var(--line);
    font-size: 12px;
    color: var(--muted);
    text-align:center;
  }

  /* mobiel: 2 kolommen */
  @media (max-width: 820px){
    .grid{
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }
  }
</style>
</head>
<body>
<div class="page">
  <div class="grid" id="grid">
    <div class="sq" id="panel0" data-key="Digit4" data-numpad="Numpad4"></div>
    <div class="sq" id="panel1" data-key="Digit5" data-numpad="Numpad5"></div>
    <div class="sq" id="panel2" data-key="Digit6" data-numpad="Numpad6"></div>
    <div class="sq" id="panel3" data-key="Digit1" data-numpad="Numpad1"></div>
    <div class="sq" id="panel4" data-key="Digit2" data-numpad="Numpad2"></div>
    <div class="sq" id="panel5" data-key="Digit3" data-numpad="Numpad3"></div>
  </div>

  <div class="bottom">
    <div class="bottomInner">
    <p class="desc">
		<b>Made to be used with numpad.</b><br>
      Keys: <b>1–6</b> = flash | Hold <b>Z X C V</b> = to Fade Out ( 50% / 100% / 150% / 200%) | <b>7</b> = random chords | <b>9</b> = flicker (change speed below)
    </p>

    <div class="controlsRow">
      <label for="flickerspeedInput">Flicker speed:</label>
      <input type="number" id="flickerspeedInput" value="300" min="30" max="1000" step="1" />
    </div>

    <footer class="footer">
      <a href="https://github.com/frietjewaterfiets" target="_blank" rel="noopener">frietjewaterfiets</a>
    </footer>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Settings (zelfde logica als oude lightpanel) =====
  const panels = Array.from(document.querySelectorAll('.sq'));

  // per panel settings (bg/flash/fade)
  // fade is in seconden, net als de slider-waarde in het oude bestand.
  const panelSettings = {};
  panels.forEach((p, i) => {
    const id = p.id;
    panelSettings[id] = {
      key: p.dataset.key,
      numpadKey: p.dataset.numpad,
      bg: getComputedStyle(document.documentElement).getPropertyValue('--panel-bg').trim() || '#000000',
      flash: getComputedStyle(document.documentElement).getPropertyValue('--flash').trim() || '#ffffff',
      fade: 0
    };
    p.style.backgroundColor = panelSettings[id].bg;
  });

  // (zet tijdelijk alle fade-waardes, en restore als je loslaat)
  const foLevels = {
    KeyZ: 50,
    KeyX: 100,
    KeyC: 150,
    KeyV: 200,
  };

  let originalFO = {};       // panelId -> originele fade
  const activeKeys = new Set();

  function applyGlobalFO(){
    const maxFO = Math.max(...Array.from(activeKeys).map(k => foLevels[k])) / 100; // 0..2
    panels.forEach((p) => {
      const id = p.id;
      panelSettings[id].fade = maxFO;
    });
  }

  function restoreFO(){
    panels.forEach((p) => {
      const id = p.id;
      if (Object.prototype.hasOwnProperty.call(originalFO, id)) {
        panelSettings[id].fade = originalFO[id];
      }
    });
    originalFO = {};
  }

  // ===== Flash / release (1–6) =====
  function matchesPanelKey(panelId, code){
    const s = panelSettings[panelId];
    return code.toUpperCase() === s.key.toUpperCase() || code.toUpperCase() === s.numpadKey.toUpperCase();
  }

  function flashOn(panelId){
    const p = document.getElementById(panelId);
    p.style.transition = 'background-color 0s';
    p.style.backgroundColor = panelSettings[panelId].flash;
  }

  function flashOff(panelId){
    const p = document.getElementById(panelId);
    const fadeTime = Number(panelSettings[panelId].fade) || 0;
    p.style.transition = (fadeTime === 0) ? 'background-color 0s' : `background-color ${fadeTime}s linear`;
    p.style.backgroundColor = panelSettings[panelId].bg;
  }

  // ===== 7 random chords — EXACT zoals oude lightpanel =====
  let activePanels = [];
  let isHoldingNumpad7 = false;

  function activateRandomPanels(isActive){
    if (!isActive) return;

    activePanels = [];
    while (activePanels.length < 3) {
      const r = Math.floor(Math.random() * panels.length);
      if (!activePanels.includes(r)) activePanels.push(r);
    }

    activePanels.forEach(idx => {
      const id = panels[idx].id;
      const p = panels[idx];
      p.style.transition = 'background-color 0s';
      p.style.backgroundColor = panelSettings[id].flash;
      p.dataset.active = 'true';
    });
  }

  function deactivateAllPanels(){
    activePanels.forEach(idx => {
      const id = panels[idx].id;
      const p = panels[idx];
      const fadeTime = Number(panelSettings[id].fade) || 0;
      p.style.transition = (fadeTime === 0) ? 'background-color 0s' : `background-color ${fadeTime}s linear`;
      p.style.backgroundColor = panelSettings[id].bg;
      p.dataset.active = 'false';
    });
    activePanels = [];
  }

  // ===== 9 flicker — implementatie zoals oude (met flickerspeedInput) =====
  let isFlashing = false;
  let flashIntervals = [];
  let flickerspeed = 300;

  const flickerInput = document.getElementById('flickerspeedInput');
  flickerInput.addEventListener('input', (e) => {
    flickerspeed = parseInt(e.target.value, 10) || 300;
  });

  function startFlashing(){
    panels.forEach((panelEl, index) => {
      function flicker(){
        if (!isFlashing) return;

        const id = panelEl.id;
        const flashColor = panelSettings[id].flash;
        const bgColor = panelSettings[id].bg;

        panelEl.style.transition = 'background-color 0s';
        panelEl.style.backgroundColor = flashColor;

        setTimeout(() => {
          if (!isFlashing) return;
          panelEl.style.transition = 'background-color 0s';
          panelEl.style.backgroundColor = bgColor;
        }, (60 / (flickerspeed / 2)) * 300);

        const nextFlicker = (60 / (flickerspeed / 2)) * (Math.random() * 600 + 200);
        flashIntervals[index] = setTimeout(flicker, nextFlicker);
      }

      // willekeurig startmoment per paneel
      setTimeout(flicker, Math.random() * (60 / (flickerspeed / 2)) * 1000);
    });
  }

  function stopFlashing(){
    flashIntervals.forEach(t => clearTimeout(t));
    flashIntervals = [];

    panels.forEach((panelEl) => {
      const id = panelEl.id;
      const bgColor = panelSettings[id].bg;
      const fadeTime = Number(panelSettings[id].fade) || 0;
      panelEl.style.transition = (fadeTime === 0) ? 'background-color 0s' : `background-color ${fadeTime}s linear`;
      panelEl.style.backgroundColor = bgColor;
    });
  }

  // ===== Key handling (één set listeners) =====
  document.addEventListener('keydown', (event) => {
    // FO keys
    if (Object.prototype.hasOwnProperty.call(foLevels, event.code)) {
      activeKeys.add(event.code);

      // sla originele fade slechts 1x op
      panels.forEach((p) => {
        const id = p.id;
        if (!Object.prototype.hasOwnProperty.call(originalFO, id)) {
          originalFO[id] = Number(panelSettings[id].fade) || 0;
        }
      });

      applyGlobalFO();
      return;
    }

    // Numpad7 (random chords)
    if (event.code === 'Numpad7' && !isHoldingNumpad7) {
      isHoldingNumpad7 = true;
      activateRandomPanels(true);
      return;
    }

    // Numpad9 (flicker)
    if (event.code === 'Numpad9' && !isFlashing) {
      isFlashing = true;
      startFlashing();
      return;
    }

    // normal flash keys
    for (const id of Object.keys(panelSettings)) {
      if (matchesPanelKey(id, event.code)) {
        flashOn(id);
      }
    }
  });

  document.addEventListener('keyup', (event) => {
    // FO keys
    if (Object.prototype.hasOwnProperty.call(foLevels, event.code)) {
      activeKeys.delete(event.code);

      if (activeKeys.size === 0) {
        restoreFO();
      } else {
        applyGlobalFO();
      }
      return;
    }

    // Numpad7 release
    if (event.code === 'Numpad7') {
      isHoldingNumpad7 = false;
      deactivateAllPanels();
      return;
    }

    // Numpad9 release
    if (event.code === 'Numpad9') {
      isFlashing = false;
      stopFlashing();
      return;
    }

    // normal flash key release
    for (const id of Object.keys(panelSettings)) {
      if (matchesPanelKey(id, event.code)) {
        flashOff(id);
      }
    }
  });

})();
</script>
</body>
</html>
